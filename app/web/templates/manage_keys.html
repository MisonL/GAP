{% extends "_base.html" %} {# 继承基础模板 #}

{% block title %}管理代理 Key{% endblock %} {# 设置页面标题 #}

{% block content %}
<!-- 代理 Key 管理主容器 -->
<div class="container mt-4" id="manage-keys-content">
    {% if is_memory_mode %} {# 如果是内存模式 #}
        <h2>代理 Key 管理</h2> {# 页面主标题 #}
        <!-- 内存模式提示警告 -->
        <div class="alert alert-warning" role="alert">
            <strong>提示：</strong> 代理 Key 管理功能仅在启用文件数据库模式时可用。当前应用运行在内存模式下。
            <br>
            如需使用此功能，请在配置文件或环境变量中设置 <code>CONTEXT_DB_PATH</code> 指向一个 SQLite 文件路径，然后重启应用。
        </div>
    {% else %} {# 如果是文件模式 #}
        <h2>管理代理 Key (文件存储模式)</h2> {# 页面主标题 #}
        <p>在这里管理用于 API 调用的代理 Key。</p> {# 页面描述 #}


    <h4>添加新 Key</h4> {# 添加新 Key 副标题 #}
    <!-- 添加新 Key 表单 -->
    <form id="add-key-form" class="mb-4">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="keyDescription" class="form-label">描述 (可选)</label> {# 描述输入框标签 #}
                <input type="text" class="form-control" id="keyDescription" placeholder="例如：用于测试客户端 A"> {# 描述输入框 #}
            </div>
            <div class="col-md-6 mb-3">
                <label for="keyExpiresAt" class="form-label">过期时间 (可选)</label> {# 过期时间输入框标签 #}
                <input type="text" class="form-control" id="keyExpiresAt" placeholder="YYYY-MM-DDTHH:MM:SSZ 或留空"> {# 过期时间输入框 #}
                <small class="form-text text-muted">ISO 8601 格式 (UTC)，例如 2025-12-31T23:59:59Z。留空表示永不过期。</small> {# 格式说明 #}
            </div>
        </div>
        {# CSRF token input removed #}
        <button type="submit" class="btn btn-primary">生成并添加 Key</button> {# 提交按钮 #}
        <span id="add-key-status" class="ms-2"></span> {# 添加状态显示区域 #} {# 添加 Key 状态显示区域 #}
    </form>

    <hr> {# 分隔线 #}

    <h4>现有 Key 列表</h4> {# 现有 Key 列表副标题 #}
    <!-- Key 列表区域 -->
    <button id="refresh-keys-btn" class="btn btn-secondary mb-3">刷新列表</button> {# 刷新列表按钮 #}
    <div id="keys-table-container"> {# Key 表格容器 #}
        <p id="loading-keys-msg">正在加载 Key 列表...</p> {# 加载提示 #}
        <!-- Key 列表表格 -->
        <table class="table table-striped table-bordered" id="keys-table" style="display: none;">
            <thead>
                <tr>
                    <th>代理 Key (点击复制)</th> {# 更新表头 #} <!-- 表头：代理 Key -->
                    <th>描述</th> <!-- 表头：描述 -->
                    <th>创建时间</th> <!-- 表头：创建时间 -->
                    <th>过期时间</th> {# 新增列 #} <!-- 表头：过期时间 -->
                    <th>状态</th> <!-- 表头：状态 -->
                    <th>操作</th> <!-- 表头：操作 -->
                </tr>
            </thead>
            <tbody id="keys-table-body">
                <!-- Key 数据将通过 JS 动态填充 -->
            </tbody>
        </table>
        <p id="no-keys-msg" style="display: none;">没有找到任何代理 Key。</p> {# 无 Key 提示 #}
        <p id="error-keys-msg" class="text-danger" style="display: none;">加载 Key 列表时出错。</p> {# 加载错误提示 #}
    </div>

    <!-- 编辑 Key 模态框 -->
    <div class="modal fade" id="editKeyModal" tabindex="-1" aria-labelledby="editKeyModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editKeyModalLabel">编辑 Key</h5> {# 模态框标题 #}
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> {# 关闭按钮 #}
          </div>
          <div class="modal-body">
            <form id="edit-key-form">
              <input type="hidden" id="editKeyInput"> {# 存储要编辑的 Key #} <!-- 隐藏输入框，存储 Key 值 -->
              <div class="mb-3">
                  <label for="editKeyDisplay" class="form-label">Key</label> {# Key 显示标签 #}
                  <input type="text" class="form-control" id="editKeyDisplay" readonly disabled> {# 显示 Key，但不可编辑 #} <!-- Key 显示输入框 -->
              </div>
              <div class="mb-3">
                <label for="editDescriptionInput" class="form-label">描述</label> {# 描述输入框标签 #}
                <input type="text" class="form-control" id="editDescriptionInput"> {# 描述输入框 #}
              </div>
              <div class="mb-3">
                <label for="editExpiresAtInput" class="form-label">过期时间</label> {# 过期时间输入框标签 #}
                <input type="text" class="form-control" id="editExpiresAtInput" placeholder="YYYY-MM-DDTHH:MM:SSZ 或留空"> {# 过期时间输入框 #}
                 <small class="form-text text-muted">ISO 8601 格式 (UTC)。留空表示永不过期。</small> {# 格式说明 #}
              </div>
               <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="editIsActiveInput"> {# 激活状态复选框 #}
                    <label class="form-check-label" for="editIsActiveInput">激活状态</label> {# 激活状态标签 #}
                </div>
            </form>
             <div id="edit-key-status" class="mt-2"></div> {# 用于显示错误或成功消息 #} {# 编辑 Key 状态显示区域 #}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button> {# 取消按钮 #}
            <button type="button" class="btn btn-primary" id="saveEditKeyBtn">保存更改</button> {# 保存更改按钮 #}
          </div>
        </div>
      </div>
    </div>

    {% endif %} {# End of 'if not is_memory_mode' #} {# 内存模式判断结束 #}
</div>

{% block scripts %} {# 脚本块 #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Only run JS if the main content is present (i.e., not in memory mode)
        // 仅在主内容存在时运行 JS (即非内存模式)
        if (document.getElementById('add-key-form')) { // 检查添加 Key 表单是否存在
        const token = localStorage.getItem('access_token'); // 从 localStorage 获取 token
        if (!token) { // 如果没有 token
            window.location.href = '/'; // 重定向到登录页
            return;
        }

        const keysTableBody = document.getElementById('keys-table-body'); // 获取 Key 表格 tbody
        const keysTable = document.getElementById('keys-table'); // 获取 Key 表格
        const loadingMsg = document.getElementById('loading-keys-msg'); // 获取加载消息元素
        const noKeysMsg = document.getElementById('no-keys-msg'); // 获取无 Key 消息元素
        const errorMsg = document.getElementById('error-keys-msg'); // 获取错误消息元素
        const addKeyForm = document.getElementById('add-key-form'); // 获取添加 Key 表单
        const keyDescriptionInput = document.getElementById('keyDescription'); // 获取描述输入框
        const addKeyStatus = document.getElementById('add-key-status'); // 获取添加 Key 状态显示区域
        const refreshBtn = document.getElementById('refresh-keys-btn');

        // 异步函数：获取 Key 列表并渲染表格
        async function fetchKeys() {
            loadingMsg.style.display = 'block'; // 显示加载消息
            keysTable.style.display = 'none'; // 隐藏表格
            noKeysMsg.style.display = 'none'; // 隐藏无 Key 消息
            errorMsg.style.display = 'none'; // 隐藏错误消息
            keysTableBody.innerHTML = ''; // 清空旧数据

            try {
                // Use standard fetch with Authorization header
                // 使用标准 fetch 并带 Authorization header
                const response = await fetch('/api/manage/keys/data', { // 发送请求获取 Key 数据
                    headers: { 'Authorization': `Bearer ${token}` } // 添加 Authorization header
                });

                if (response.status === 401 || response.status === 403) { // 如果认证失败或无权限
                    // 403 might also mean non-admin trying to access
                    // 403 也可能意味着非管理员尝试访问
                    console.error('Manage Keys: Access denied (401/403). Removing token and redirecting.');
                    localStorage.removeItem('access_token'); // 清除 token
                    window.location.href = '/'; // 重定向到登录页
                    return;
                }
                 if (response.status === 404) { // 404 表示非文件模式
                    loadingMsg.textContent = '代理 Key 管理仅在文件存储模式下可用。'; // 更新加载消息文本
                    return; // 不再继续处理
                }
                if (!response.ok) { // 如果响应不成功
                    throw new Error(`HTTP error! status: ${response.status}`); // 抛出错误
                }

                const data = await response.json(); // 解析 JSON 数据

                // --- Admin Check ---
                // --- 管理员检查 ---
                const isAdmin = data.is_admin === true; // 明确检查布尔值 true
                const addKeySectionTitle = document.querySelector('#add-key-form').previousElementSibling; // Assuming h4 is directly before form
                if (!isAdmin) { // 如果不是管理员
                    if (addKeyForm) addKeyForm.style.display = 'none'; // 隐藏添加 Key 表单
                    if (addKeySectionTitle && addKeySectionTitle.tagName === 'H4') {
                         addKeySectionTitle.style.display = 'none'; // 隐藏添加 Key 标题
                    }
                    // Also hide the hr separator after the add form
                    // 也隐藏添加表单后的 hr 分隔线
                    const hrSeparator = document.querySelector('#add-key-form + hr');
                     if (hrSeparator) hrSeparator.style.display = 'none'; // 隐藏分隔线
                } else {
                     // Ensure they are visible for admins
                     // 确保它们对管理员可见
                     if (addKeyForm) addKeyForm.style.display = ''; // 显示添加 Key 表单
                     if (addKeySectionTitle && addKeySectionTitle.tagName === 'H4') {
                          addKeySectionTitle.style.display = ''; // 显示添加 Key 标题
                     }
                     const hrSeparator = document.querySelector('#add-key-form + hr');
                     if (hrSeparator) hrSeparator.style.display = ''; // 显示分隔线
                }
                // --- End Admin Check ---

                loadingMsg.style.display = 'none'; // 隐藏加载消息

                if (data.keys && data.keys.length > 0) { // Corrected: Use && instead of && // 如果有 Key 数据
                    keysTable.style.display = 'table'; // 显示表格
                    data.keys.forEach(keyInfo => { // 遍历 Key 数据
                        const row = keysTableBody.insertRow(); // 插入新行
                        // Corrected: Use > and < instead of > and < inside template literal
                        // Format expires_at
                        // 格式化 expires_at
                        let expiresAtDisplay = '永不'; // 默认显示 '永不'
                        if (keyInfo.expires_at) { // 如果有过期时间
                            try {
                                expiresAtDisplay = new Date(keyInfo.expires_at).toLocaleString('sv-SE'); // YYYY-MM-DD HH:MM:SS (使用瑞典格式格式化日期)
                            } catch (e) {
                                console.warn(`无法解析过期日期: ${keyInfo.expires_at}`, e);
                                expiresAtDisplay = keyInfo.expires_at; // 显示原始字符串
                            }
                        }

                        // Conditionally add action buttons based on isAdmin status
                        // 根据 isAdmin 状态条件性地添加操作按钮
                        let actionButtonsHTML = ''; // 初始化操作按钮 HTML
                        if (isAdmin) { // 如果是管理员
                            actionButtonsHTML = `
                                <button class="btn btn-sm btn-warning edit-btn"
                                        data-key="${keyInfo.key}"
                                        data-description="${keyInfo.description || ''}"
                                        data-is-active="${keyInfo.is_active}"
                                        data-expires-at="${keyInfo.expires_at || ''}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editKeyModal">编辑</button>
                                <button class="btn btn-sm btn-danger delete-btn" data-key="${keyInfo.key}">删除</button>
                            `;
                        } else { // 如果不是管理员
                             actionButtonsHTML = '<span>N/A</span>'; // Or just leave it empty: '' (显示 N/A)
                        }

                        // 构建表格行 HTML
                        row.innerHTML = `
                            <td><span class="key-value" title="点击复制">${keyInfo.key}</span></td> <!-- Key 值，点击复制 -->
                            <td>${keyInfo.description || ''}</td> <!-- 描述 -->
                            <td>${new Date(keyInfo.created_at).toLocaleString('sv-SE')}</td> {# Use consistent format #} <!-- 创建时间 -->
                            <td>${expiresAtDisplay}</td> {# Add expires_at column #} <!-- 过期时间 -->
                            <td>
                                <span class="badge ${keyInfo.is_active ? 'bg-success' : 'bg-secondary'}">
                                    ${keyInfo.is_active ? '活动' : '禁用'}
                                </span>
                                {# Toggle button removed, handled in Edit modal #}
                            </td>
                            <td>${actionButtonsHTML}</td>
                        `; // Corrected: Moved comment outside template literal

                    });
                    attachEventListeners(); // 绑定事件监听器
                } else { // 如果没有 Key 数据
                    noKeysMsg.style.display = 'block'; // 显示无 Key 消息
                }
            } catch (error) { // 捕获错误
                console.error('Error fetching keys:', error);
                loadingMsg.style.display = 'none'; // 隐藏加载消息
                errorMsg.style.display = 'block'; // 显示错误消息
            }
        }

        // 绑定事件监听器的函数
        function attachEventListeners() {
            // 复制 Key
            // Copy Key
            document.querySelectorAll('.key-value').forEach(span => { // 遍历所有 Key 值元素
                span.style.cursor = 'pointer'; // 设置鼠标样式为手型
                span.addEventListener('click', () => { // 监听点击事件
                    navigator.clipboard.writeText(span.textContent).then(() => { // 复制文本到剪贴板
                        alert('Key 已复制到剪贴板'); // 显示成功提示
                    }).catch(err => {
                        console.error('无法复制 Key:', err); // 记录错误
                        alert('复制失败'); // 显示失败提示
                    });
                });
            });

            // 切换状态按钮的逻辑已合并到编辑模态框中
            // Toggle status button logic is merged into the edit modal

            // 删除 Key
            // Delete Key
            document.querySelectorAll('.delete-btn').forEach(button => { // 遍历所有删除按钮
                button.addEventListener('click', async (event) => { // 监听点击事件
                    const key = event.target.dataset.key; // 获取 Key 值
                    if (!confirm(`确定要删除 Key "${key.substring(0, 8)}..." 吗？这将同时删除关联的上下文记录！`)) { // 确认删除
                        return;
                    }
                    try {
                        // Use standard fetch for DELETE request
                        // 使用标准 fetch 发送 DELETE 请求
                        const response = await fetch(`/api/manage/keys/delete/${key}`, { // 发送 DELETE 请求
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` } // 添加 Authorization header
                        });
                        if (response.status === 401 || response.status === 403) { // 如果认证失败或无权限
                             alert('认证失败或无权限删除。'); // 显示错误提示
                             localStorage.removeItem('access_token'); // 清除 token
                             window.location.href = '/'; // 重定向到登录页
                             return;
                         }
                        // Check for 204 No Content specifically for successful delete
                        // 特别检查 204 No Content 表示成功删除
                        if (response.status === 204) { // 如果状态码是 204
                             fetchKeys(); // 重新加载列表
                        } else if (!response.ok) { // 如果响应不成功
                             // Try to get error detail
                             // 尝试获取错误详情
                             let errorDetail = `HTTP error! status: ${response.status}`; // 默认错误详情
                             try {
                                 const errorData = await response.json().catch(() => ({ detail: '添加失败，请检查日志。' }));
                                 if (errorData.detail) errorDetail = errorData.detail;
                             } catch(e) { /* ignore json parsing error */ }
                             throw new Error(errorDetail); // 抛出错误
                        } else {
                             // Handle unexpected success status codes if necessary
                             // 如果需要，处理意外的成功状态码
                             console.warn("Delete request returned unexpected success status:", response.status);
                             fetchKeys(); // Still reload on other success codes (仍然在其他成功状态码下重新加载)
                        }
                    } catch (error) { // 捕获错误
                        console.error('Error deleting key:', error);
                        alert(`删除 Key 失败: ${error.message}`); // 显示错误提示
                    }
                });
            });

            // 编辑 Key 按钮点击处理
            // Edit Key button click handling
            document.querySelectorAll('.edit-btn').forEach(button => { // 遍历所有编辑按钮
                button.addEventListener('click', (event) => { // 监听点击事件
                    const key = event.target.dataset.key; // 获取 Key 值
                    const description = event.target.dataset.description; // 获取描述
                    const isActive = event.target.dataset.isActive === 'true'; // 获取激活状态
                    const expiresAt = event.target.dataset.expiresAt || ''; // Get expires_at, default to empty string (获取过期时间，默认为空字符串)

                    // 填充模态框
                    // Populate modal
                    document.getElementById('editKeyInput').value = key; // Hidden input (隐藏输入框)
                    document.getElementById('editKeyDisplay').value = key; // Display input (显示输入框)
                    document.getElementById('editDescriptionInput').value = description; // 填充描述
                    document.getElementById('editIsActiveInput').checked = isActive; // 填充激活状态
                    document.getElementById('editExpiresAtInput').value = expiresAt; // Populate expires_at input (填充过期时间输入框)
                    document.getElementById('edit-key-status').textContent = ''; // Clear previous status (清除之前的状态)
                });
            });
        }

        // 添加 Key 表单提交
        // Add Key form submission
        addKeyForm.addEventListener('submit', async (event) => { // 监听表单提交事件
            event.preventDefault(); // 阻止默认提交
            const description = keyDescriptionInput.value.trim(); // 获取描述并去除空格
            const expiresAt = document.getElementById('keyExpiresAt').value.trim(); // 获取过期时间并去除空格
            addKeyStatus.textContent = '正在添加...'; // 显示添加状态
            addKeyStatus.className = 'ms-2 text-info';

             // Basic ISO format check for expires_at
             // 对 expires_at 进行基本的 ISO 格式检查
            if (expiresAt && !/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(Z|[+-]\d{2}:\d{2})$/.test(expiresAt)) { // 如果提供了过期时间且格式不匹配
                 addKeyStatus.textContent = '添加失败: 过期时间格式无效。'; // 显示错误消息
                 addKeyStatus.className = 'ms-2 text-danger';
                 return;
            }

            try {
                // Use standard fetch for POST request
                // 使用标准 fetch 发送 POST 请求
                const response = await fetch('/api/manage/keys/add', { // 发送 POST 请求添加 Key
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`, // 添加 Authorization 头
                        'Content-Type': 'application/json' // 设置 Content-Type
                    },
                    body: JSON.stringify({ // 发送 JSON 数据
                        description: description || null, // 发送 null 如果为空
                        expires_at: expiresAt || null // 发送 null 如果为空
                    })
                });

                if (response.status === 401 || response.status === 403) { // 如果认证失败或无权限
                     addKeyStatus.textContent = '认证失败或无权限。'; // 显示错误消息
                     addKeyStatus.className = 'ms-2 text-danger';
                     localStorage.removeItem('access_token'); // 清除 token
                     window.location.href = '/'; // 重定向到登录页
                     return;
                 }

                if (!response.ok) { // 如果响应不成功
                    const errorData = await response.json().catch(() => ({ detail: '添加失败，请检查日志。' })); // 尝试解析错误响应 JSON
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`); // 抛出错误
                }

                const result = await response.json(); // 解析 JSON 数据
                // Corrected access to key based on API response structure in routes.py
                // 根据 routes.py 中的 API 响应结构修正 Key 的访问方式
                const newKey = result.key && result.key.key ? result.key.key : '未知'; // 获取新 Key 值
                addKeyStatus.textContent = `添加成功！新 Key: ${newKey.substring(0, 8)}...`; // 显示成功消息
                addKeyStatus.className = 'ms-2 text-success';
                keyDescriptionInput.value = ''; // 清空描述输入框
                document.getElementById('keyExpiresAt').value = ''; // 清空过期时间输入框
                fetchKeys(); // 重新加载列表
            } catch (error) { // 捕获错误
                console.error('Error adding key:', error);
                addKeyStatus.textContent = `添加失败: ${error.message}`; // 显示错误消息
                addKeyStatus.className = 'ms-2 text-danger';
            }
        });

        // 刷新按钮
        // Refresh button
        refreshBtn.addEventListener('click', fetchKeys); // 监听点击事件，调用 fetchKeys

        // 初始加载
        // Initial load
        fetchKeys(); // 页面加载时获取 Key 列表

        // 编辑 Key 模态框保存
        // Edit Key modal save
        const saveEditBtn = document.getElementById('saveEditKeyBtn'); // 获取保存按钮
        const editModalElement = document.getElementById('editKeyModal'); // 获取模态框元素
        const editModal = bootstrap.Modal.getOrCreateInstance(editModalElement); // Get modal instance (获取模态框实例)

        if (saveEditBtn && editModal) { // 如果保存按钮和模态框实例存在
            saveEditBtn.addEventListener('click', async () => { // 监听点击事件
                const key = document.getElementById('editKeyInput').value; // 获取 Key 值
                const newDescription = document.getElementById('editDescriptionInput').value.trim(); // 获取新描述
                const newIsActive = document.getElementById('editIsActiveInput').checked; // 获取新激活状态
                const newExpiresAt = document.getElementById('editExpiresAtInput').value.trim(); // 获取新过期时间
                const editStatus = document.getElementById('edit-key-status'); // 获取编辑状态显示区域

                editStatus.textContent = '正在保存...'; // 显示保存状态
                editStatus.className = 'mt-2 text-info';

                const payload = { // 构建请求体 payload
                    // Only include fields if they have changed? Or send all?
                    // 仅包含已更改的字段？还是发送所有？
                    // Sending all is simpler for now. Backend handles None.
                    // 目前发送所有更简单。后端处理 None。
                    description: newDescription, // Send empty string if needed, or handle null in backend (描述)
                    is_active: newIsActive, // 激活状态
                    expires_at: newExpiresAt || null // Send null if empty string (过期时间，如果为空字符串则发送 null)
                };

                 // Basic ISO format check for expires_at
                 // 对 expires_at 进行基本的 ISO 格式检查
                if (payload.expires_at && !/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(Z|[+-]\d{2}:\d{2})$/.test(payload.expires_at)) { // 如果提供了过期时间且格式不匹配
                     editStatus.textContent = '保存失败: 过期时间格式无效。'; // 显示错误消息
                     editStatus.className = 'mt-2 text-danger';
                     return;
                }


                try {
                    // Use standard fetch for PUT request
                    // 使用标准 fetch 发送 PUT 请求
                    const response = await fetch(`/api/manage/keys/update/${key}`, { // 发送 PUT 请求更新 Key
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`, // 添加 Authorization 头
                            'Content-Type': 'application/json' // 设置 Content-Type
                        },
                        body: JSON.stringify(payload) // 发送 JSON 数据
                    });

                    if (response.status === 401 || response.status === 403) { // 如果认证失败或无权限
                         editStatus.textContent = '认证失败或无权限。'; // 显示错误消息
                         editStatus.className = 'mt-2 text-danger';
                         localStorage.removeItem('access_token'); // 清除 token
                         // Don't close modal, let user see error, maybe redirect later
                         // 不要关闭模态框，让用户看到错误，稍后可能重定向
                         // window.location.href = '/';
                         return;
                     }
                    if (!response.ok) { // 如果响应不成功
                         const errorData = await response.json().catch(() => ({ detail: '保存失败，请检查日志。' })); // 尝试解析错误响应 JSON
                         throw new Error(errorData.detail || `HTTP error! status: ${response.status}`); // 抛出错误
                    }

                    editStatus.textContent = '保存成功!'; // 显示成功消息
                    editStatus.className = 'mt-2 text-success';

                    // Close modal after a short delay and refresh list
                    // 短暂延迟后关闭模态框并刷新列表
                    setTimeout(() => {
                        editModal.hide(); // 隐藏模态框
                        fetchKeys(); // 重新加载列表
                    }, 1000); // 延迟 1 秒

                } catch (error) { // 捕获错误
                    console.error('Error updating key:', error);
                    editStatus.textContent = `保存失败: ${error.message}`; // 显示错误消息
                    editStatus.className = 'mt-2 text-danger';
                }
            });
        } else {
             console.error("Could not find save button or initialize edit modal."); // Log error
        }

        } // End of 'if (document.getElementById('add-key-form'))' // 内存模式判断结束
    });
</script>
{% endblock %} {# 脚本块结束 #}

</final_file_content>

重要提示：对于此文件的任何未来更改，请使用上面显示的 final_file_content 作为参考。此内容反映了文件的当前状态，包括任何自动格式化（例如，如果您使用了单引号但格式化程序将其转换为双引号）。始终基于此最终版本进行 SEARCH/REPLACE 操作以确保准确性。

<environment_details>
# VSCode 可见文件
app/web/templates/manage_keys.html

# VSCode 打开的标签页
.env
app/main.py
gemini_v2_api_plan.md
readme.md
context_management_plan.md
../../../../Users/mison/Library/Application Support/Code/User/globalStorage/hybridtalentcomputing.cline-chinese/settings/cline_mcp_settings.json
app/core/usage_reporter.py
app/config.py
app/core/reporting.py
app/core/tracking.py
app/core/utils.py
app/core/gemini.py
app/core/response_wrapper.py
app/core/context_store.py
app/core/daily_reset.py
app/core/db_settings.py
app/core/db_utils.py
app/core/key_management.py
app/api/endpoints.py
app/api/middleware.py
app/api/models.py
app/api/request_processor.py
app/api/request_utils.py
app/handlers/log_config.py
app/handlers/error_handlers.py
app/web/routes.py
app/web/auth.py
app/web/templates/_base.html
app/web/templates/login.html
app/web/templates/manage_context.html
app/web/templates/manage_keys.html
LICENSE
LICENSE.zh-CN

# 当前时间
2025/4/24 下午3:06:20 (Asia/Shanghai, UTC+8:00)

# 当前模式
行动模式
</environment_details>

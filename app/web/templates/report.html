{% extends "_base.html" %}

{% block title %}API 使用情况报告{% endblock %}

{% block content %}
<div class="container-lg mt-4 px-lg-5 px-md-4 px-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>API 使用情况报告</h1>
        <small class="text-muted">最后更新时间: <span id="last-updated-time">加载中...</span></small>
    </div>

    <div class="row">
        <!-- 左列 -->
        <div class="col-lg-6">
            <!-- 容量与使用情况 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">容量与使用情况</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- RPD 图表 -->
                        <div class="col-md-6 text-center mb-3 mb-md-0"> <!-- 调整为 col-md-6 -->
                            <h6>RPD (每日请求)</h6>
                            <div class="chart-container mx-auto" style="position: relative;">
                                <canvas id="rpd-chart"></canvas>
                                <div id="rpd-percentage" class="chart-percentage">--%</div>
                            </div>
                            <p id="rpd-stats" class="mt-2 small text-muted">加载中...</p>
                        </div>
                        <!-- TPD 输入图表 -->
                        <div class="col-md-6 text-center mb-3 mb-md-0"> <!-- 调整为 col-md-6 -->
                             <h6>TPD 输入 (每日 Token)</h6>
                             <div class="chart-container mx-auto" style="position: relative;">
                                <canvas id="tpd-input-chart"></canvas>
                                <div id="tpd-input-percentage" class="chart-percentage">--%</div>
                            </div>
                            <p id="tpd-input-stats" class="mt-2 small text-muted">加载中...</p>
                        </div>
                        <!-- 关键统计数据 -->
                        <div class="col-12 mt-4"> <!-- 调整为 col-12 并添加上边距 -->
                            <h6>关键指标</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    活跃 Key 数量:
                                    <span id="active-keys-count" class="badge bg-primary rounded-pill">...</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    启动时无效 Key:
                                    <span id="invalid-keys-startup" class="badge bg-warning text-dark rounded-pill">...</span>
                                </li>
                                 <li class="list-group-item d-flex justify-content-between align-items-center">
                                    过去 7 天平均日 RPD:
                                    <span id="avg-daily-rpd" class="badge bg-info rounded-pill">...</span>
                                </li>
                               <!-- RPD 容量列表容器 -->
                               <li id="rpd-capacity-list-container" class="list-group-item">
                                   RPD 容量估算:
                                   {% if has_valid_keys %}
                                   <div class="small text-muted mt-1">加载中...</div>
                                   {% else %}
                                   <div class="small mt-1">无有效 API Key，无法估算容量</div> {# 无有效 Key 时的提示 #}
                                   {% endif %}
                               </li>
                               <!-- TPD 输入容量列表容器 -->
                               <li id="tpd-input-capacity-list-container" class="list-group-item">
                                   TPD 输入容量估算:
                                   {% if has_valid_keys %}
                                   <div class="small text-muted mt-1">加载中...</div>
                                   {% else %}
                                   <div class="small mt-1">无有效 API Key，无法估算容量</div> {# 无有效 Key 时的提示 #}
                                   {% endif %}
                               </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key 使用概览 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Key 使用概览</h5>
                </div>
                <div class="card-body">
                    <div id="key-status-charts" class="row justify-content-center">
                        <!-- 图表将动态添加到这里 -->
                        <p id="key-status-loading" class="text-center text-muted">正在加载 Key 状态图表...</p>
                    </div>
                    <hr>
                    <h6>状态详情</h6>
                    <div id="key-status-details" class="mt-3 small">
                        <!-- 详细状态文本将添加到这里 -->
                         <p class="text-center text-muted">暂无详情数据。</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右列 -->
        <div class="col-lg-6">
            <!-- Key 数量建议 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                     <h5 class="mb-0">Key 数量建议</h5>
                </div>
                <div class="card-body">
                    <p id="key-suggestion" class="lead">正在加载建议...</p>
                </div>
            </div>

            <!-- Top IP 统计 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Top 5 IP 地址统计 (PT 时间)</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h6>请求次数</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped table-hover">
                                    <thead class="table-light">
                                        <tr><th>时间范围</th><th>IP 地址</th><th>次数</th></tr>
                                    </thead>
                                    <tbody id="top-ips-requests">
                                        <tr><td colspan="3" class="text-center text-muted">正在加载...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-12">
                            <h6>输入 Token</h6>
                            <div class="table-responsive">
                                 <table class="table table-sm table-striped table-hover">
                                    <thead class="table-light">
                                        <tr><th>时间范围</th><th>IP 地址</th><th>Token 数</th></tr>
                                    </thead>
                                    <tbody id="top-ips-tokens">
                                         <tr><td colspan="3" class="text-center text-muted">正在加载...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- end .row -->

</div>

<!-- 引入 Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<!-- 引入 chartjs-adapter-date-fns (如果需要时间轴) -->
<!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script> -->

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}

/* 在环形图中心显示百分比的样式 */
/* Style to display percentage in the center of doughnut chart */
.chart-container {
    position: relative;
    margin: auto;
    /* height: 180px; */ /* Removed fixed height */
    /* width: 180px; */  /* Removed fixed width */
    max-width: 180px; /* 添加最大宽度以控制大小 */
}
.chart-percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.5rem; /* 调整字体大小 */
    font-weight: bold;
    color: #495057; /* 调整颜色 */
    pointer-events: none; /* 确保不影响图表交互 */
}
/* 确保 Key 状态图表在列内响应式 */
#key-status-charts .col-lg-3,
#key-status-charts .col-md-4,
#key-status-charts .col-sm-6 {
    /* 可以根据需要调整图表大小 */
    max-width: 200px; /* 限制图表容器的最大宽度 */
    margin-left: auto;
    margin-right: auto;
}
#key-status-charts canvas {
    max-height: 150px; /* 限制 Canvas 高度 */
}

/* 修正 Bootstrap 栅格列在宽屏下的宽度优先级问题 */
@media (min-width: 992px) { /* Bootstrap's 'lg' breakpoint */
    .row .col-lg-6 { /* Increased specificity to override .row > * */
        flex: 0 0 auto; /* Ensure flex properties are set */
        width: 50% !important; /* Force width */
    }
}

</style>

<script>
    // --- 获取 Token ---
    const token = localStorage.getItem('access_token'); // 从 localStorage 获取 token
    if (!token) { // 如果没有 token
        console.log('Report Page: No token found, redirecting to login.');
        window.location.href = '/'; // 重定向到登录页
        // 停止执行后续代码，或者将所有逻辑包裹在 if(token) 中
        // Stop executing subsequent code, or wrap all logic in if(token)
        // 为了简单起见，这里直接返回，但更好的做法是将后续逻辑放入函数并在 token 存在时调用
        // For simplicity, return here, but a better approach is to put subsequent logic in a function and call it if token exists
        // throw new Error("No token found, stopping script execution."); // 或者抛出错误
    } else {
        console.log('Report Page: Token found.');
    }


    // 全局变量存储图表实例，方便更新
    // Global variables to store chart instances for updates
    let rpdChartInstance = null;
    let tpdInputChartInstance = null;
    let keyStatusChartInstances = {}; // 按模型存储 Key 状态图表 (Store key status charts by model)

    // 格式化数字（添加千位分隔符）
    // Format number (add thousand separators)
    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) {
            return 'N/A';
        }
        return num.toLocaleString();
    }

    // 渲染 Key 状态图表
    // Render Key Status Charts
    function renderKeyStatusCharts(keyStatusData) {
        const chartsContainer = document.getElementById('key-status-charts');
        const detailsContainer = document.getElementById('key-status-details');
        if (chartsContainer) chartsContainer.innerHTML = ''; // 清空加载提示 (Clear loading message)
        if (detailsContainer) detailsContainer.innerHTML = ''; // 清空旧详情 (Clear old details)
        keyStatusChartInstances = {}; // 重置图表实例存储 (Reset chart instance storage)

        if (!keyStatusData || Object.keys(keyStatusData).length === 0) {
            if (chartsContainer) chartsContainer.innerHTML = '<p class="text-center text-muted col-12">暂无 Key 使用数据。</p>'; // No data message
            if (detailsContainer) detailsContainer.innerHTML = '<p class="text-center text-muted">暂无详情数据。</p>';
            return;
        }

        // 为每个模型创建图表和详情
        // Create chart and details for each model
        Object.entries(keyStatusData).forEach(([modelName, statusInfo]) => {
            const totalKeys = statusInfo.total_keys;
            const statuses = statusInfo.statuses;

            // 1. 创建图表容器和 Canvas
            // 1. Create chart container and Canvas
            const chartCol = document.createElement('div');
            // 调整列宽以适应更多图表或提供更多空间
            // Adjust column width for more charts or more space
            // 使用更灵活的列定义，让它们在不同尺寸下更好地排列
            chartCol.className = 'col-lg-4 col-md-6 col-sm-6 mb-4 text-center'; // 调整列定义
            const chartTitle = document.createElement('h6');
            // chartTitle.className = 'text-center mb-2'; // 移到 col 的 text-center
            chartTitle.textContent = `${modelName} (${totalKeys} Keys)`;
            const canvas = document.createElement('canvas');
            canvas.id = `key-status-chart-${modelName}`;
            // canvas.style.maxWidth = '150px'; // Removed max width constraint
            // canvas.style.maxHeight = '150px'; // Removed max height constraint
            canvas.style.margin = '0 auto'; // 居中
            // canvas.width = 150; // 使用 CSS 控制大小
            // canvas.height = 150; // 使用 CSS 控制大小
            chartCol.appendChild(chartTitle);
            chartCol.appendChild(canvas);
            if (chartsContainer) chartsContainer.appendChild(chartCol);

            // 2. 准备图表数据
            // 2. Prepare chart data
            const labels = Object.keys(statuses);
            const dataCounts = Object.values(statuses);
            // 可以定义一些颜色 (Can define some colors)
            const backgroundColors = [
                'rgba(40, 167, 69, 0.7)',  // 成功 (Success Green)
                'rgba(255, 193, 7, 0.7)',  // 警告/接近限制 (Warning Yellow)
                'rgba(220, 53, 69, 0.7)',  // 错误/超限 (Error Red)
                'rgba(0, 123, 255, 0.7)', // 信息/正常 (Info Blue)
                'rgba(108, 117, 125, 0.7)',// 灰色/未知 (Gray/Unknown)
                'rgba(111, 66, 193, 0.7)' // 紫色 (Purple)
            ];
            const borderColors = backgroundColors.map(color => color.replace('0.7', '1')); // 更深的边框色 (Darker border color)

            // 3. 创建图表实例
            // 3. Create chart instance
            const ctx = canvas.getContext('2d');
            keyStatusChartInstances[modelName] = new Chart(ctx, {
                type: 'pie', // 或 'doughnut' (or 'doughnut')
                data: {
                    // 截断标签，完整标签在 tooltip 显示
                    // Truncate labels, full labels shown in tooltip
                    labels: labels.map(label => label.length > 20 ? `${label.substring(0, 18)}...` : label),
                    datasets: [{
                        label: 'Key 数量', // Dataset label
                        data: dataCounts,
                        backgroundColor: backgroundColors.slice(0, dataCounts.length),
                        borderColor: borderColors.slice(0, dataCounts.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // 设置为 false 以更好地填充容器 (Set to false to better fill container)
                    plugins: {
                        legend: {
                            position: 'bottom', // 图例位置 (Legend position)
                            labels: {
                                boxWidth: 10, // 图例颜色框大小 (Legend color box size)
                                padding: 15, // 图例项间距 (Padding between legend items)
                                font: {
                                    size: 10 // 图例字体大小 (Legend font size)
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                     // 在提示中显示完整状态和数量
                                    // Show full status and count in tooltip
                                    let originalLabel = labels[context.dataIndex] || '';
                                    let value = context.parsed || 0;
                                    return `${originalLabel}: ${formatNumber(value)}`;
                                }
                            }
                        }
                    }
                }
            });

            // 4. 添加详细状态文本
            // 4. Add detailed status text
            const detailDiv = document.createElement('div');
            detailDiv.className = 'mb-3 border-start ps-3'; // 添加左边框和内边距
            let detailHtml = `<h6>${modelName}</h6><ul>`;
            Object.entries(statuses).forEach(([status, count]) => {
                detailHtml += `<li>${status}: ${formatNumber(count)}</li>`;
            });
            detailHtml += `</ul>`;
            detailDiv.innerHTML = detailHtml;
            if (detailsContainer) detailsContainer.appendChild(detailDiv);
        });
         // 如果没有图表，显示提示
         // If no charts, show message
        if (Object.keys(keyStatusChartInstances).length === 0) {
             if (chartsContainer) chartsContainer.innerHTML = '<p class="text-center text-muted col-12">暂无 Key 使用数据可供可视化。</p>'; // No data for visualization
             if (detailsContainer) detailsContainer.innerHTML = '<p class="text-center text-muted">暂无详情数据。</p>';
        } else {
            // 如果有数据，移除详情区域的默认提示
            // If there is data, remove the default message in the details area
            const defaultDetailMsg = detailsContainer ? detailsContainer.querySelector('p.text-center.text-muted') : null;
            if (defaultDetailMsg) defaultDetailMsg.remove();
        }
    }


    // 渲染容量图表
    // Render Capacity Charts
    function renderCapacityCharts(rpdData, tpdInputData) {
        const rpdCanvas = document.getElementById('rpd-chart');
        const tpdInputCanvas = document.getElementById('tpd-input-chart');
        const rpdPercentageDiv = document.getElementById('rpd-percentage');
        const tpdInputPercentageDiv = document.getElementById('tpd-input-percentage');
        const rpdStatsElem = document.getElementById('rpd-stats');
        const tpdInputStatsElem = document.getElementById('tpd-input-stats');


        // 销毁旧图表实例（如果存在）
        // Destroy old chart instances (if they exist)
        if (rpdChartInstance) rpdChartInstance.destroy();
        if (tpdInputChartInstance) tpdInputChartInstance.destroy();

        // RPD 图表
        // RPD Chart
        if (rpdCanvas && rpdData && rpdData.capacity > 0) {
            const rpdCtx = rpdCanvas.getContext('2d');
            // 优先使用预估值计算百分比，如果预估值为0或无效，则使用实际已用值
            // Prioritize estimated value for percentage calculation, use actual used value if estimate is 0 or invalid
            const rpdUsedValue = (rpdData.estimated_today && rpdData.estimated_today > 0) ? rpdData.estimated_today : rpdData.used_today;
            const rpdUsageRatio = (rpdUsedValue / rpdData.capacity) * 100;
            const rpdRemainingRatio = Math.max(0, 100 - rpdUsageRatio); // 确保不为负 (Ensure not negative)
            rpdChartInstance = new Chart(rpdCtx, {
                type: 'doughnut',
                data: {
                    labels: ['已用/预估', '剩余'], // Labels
                    datasets: [{
                        data: [rpdUsageRatio, rpdRemainingRatio], // 使用原始比例，格式化在 tooltip 中
                        backgroundColor: ['rgba(220, 53, 69, 0.7)', 'rgba(40, 167, 69, 0.7)'], // Red, Green
                        borderColor: ['rgba(220, 53, 69, 1)', 'rgba(40, 167, 69, 1)'],
                        borderWidth: 1,
                        circumference: 180, // 半圆 (Semicircle)
                        rotation: -90 // 从顶部开始 (Start from top)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, // 保持宽高比
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                }
                            }
                        },
                        legend: { display: false } // 隐藏图例 (Hide legend)
                    },
                    cutout: '70%' // 环形图粗细 (Doughnut thickness)
                }
            });
            // 更新图表中心的百分比
            // Update percentage in the center of the chart
            if (rpdPercentageDiv) rpdPercentageDiv.textContent = `${rpdUsageRatio.toFixed(1)}%`;
            // 更新下方的统计文本
            // Update the stats text below
            if (rpdStatsElem) rpdStatsElem.textContent = `已用: ${formatNumber(rpdData.used_today)}, 预估: ${formatNumber(rpdData.estimated_today) || 'N/A'} / 容量: ${formatNumber(rpdData.capacity)}`;
        } else {
             if (rpdStatsElem) rpdStatsElem.textContent = `已用: ${formatNumber(rpdData?.used_today)}, 容量: ${formatNumber(rpdData?.capacity) || 'N/A'}`;
             if (rpdPercentageDiv) rpdPercentageDiv.textContent = '--%';
             // 可以选择隐藏 Canvas 或显示无数据消息
             // Optionally hide Canvas or show no data message
         }

         // TPD 输入图表
         // TPD Input Chart
        if (tpdInputCanvas && tpdInputData && tpdInputData.capacity > 0) {
            const tpdInputCtx = tpdInputCanvas.getContext('2d');
            const tpdInputUsedValue = (tpdInputData.estimated_today && tpdInputData.estimated_today > 0) ? tpdInputData.estimated_today : tpdInputData.used_today;
            const tpdInputUsageRatio = (tpdInputUsedValue / tpdInputData.capacity) * 100;
            const tpdInputRemainingRatio = Math.max(0, 100 - tpdInputUsageRatio); // 确保不为负 (Ensure not negative)
            tpdInputChartInstance = new Chart(tpdInputCtx, {
                type: 'doughnut',
                data: {
                    labels: ['已用/预估', '剩余'], // Labels
                    datasets: [{
                        data: [tpdInputUsageRatio, tpdInputRemainingRatio], // 使用原始比例，格式化在 tooltip 中
                        backgroundColor: ['rgba(220, 53, 69, 0.7)', 'rgba(40, 167, 69, 0.7)'], // Red, Green
                        borderColor: ['rgba(220, 53, 69, 1)', 'rgba(40, 167, 69, 1)'],
                        borderWidth: 1,
                        circumference: 180, // 半圆 (Semicircle)
                        rotation: -90 // 从顶部开始 (Start from top)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, // 保持宽高比
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                }
                            }
                        },
                        legend: { display: false } // 隐藏图例 (Hide legend)
                    },
                    cutout: '70%' // 环形图粗细 (Doughnut thickness)
                }
            });
            // 更新图表中心的百分比
            // Update percentage in the center of the chart
            // 修正可能的 ReferenceError: 确保引用的是正确的变量名 tpdInputPercentageDiv
            if (tpdInputPercentageDiv) {
                tpdInputPercentageDiv.textContent = `${tpdInputUsageRatio.toFixed(1)}%`;
            } else {
                 console.error("Element with ID 'tpd-input-percentage' not found."); // 添加错误日志
            }
            // 更新下方的统计文本
            // Update the stats text below
            if (tpdInputStatsElem) {
                tpdInputStatsElem.textContent = `已用: ${formatNumber(tpdInputData.used_today)}, 预估: ${formatNumber(tpdInputData.estimated_today) || 'N/A'} / 容量: ${formatNumber(tpdInputData.capacity)}`;
            } else {
                 console.error("Element with ID 'tpd-input-stats' not found."); // 添加错误日志
            }
        } else {
            // 如果没有容量数据，更新统计文本和百分比显示
            // If no capacity data, update stats text and percentage display
            if (tpdInputStatsElem) {
                 tpdInputStatsElem.textContent = `已用: ${formatNumber(tpdInputData?.used_today)}, 容量: ${formatNumber(tpdInputData?.capacity) || 'N/A'}`;
            } else {
                 console.error("Element with ID 'tpd-input-stats' not found."); // 添加错误日志
            }
            if (tpdInputPercentageDiv) {
                 tpdInputPercentageDiv.textContent = '--%';
            } else {
                 console.error("Element with ID 'tpd-input-percentage' not found."); // 添加错误日志
            }
        }
    }


    // 填充 Top IP 表格
    // Populate Top IP Tables
    function populateTopIpTables(topIps) {
        const requestsBody = document.getElementById('top-ips-requests');
        const tokensBody = document.getElementById('top-ips-tokens');
        if (!requestsBody && !tokensBody) return; // 如果两个表格体都不存在，直接返回

        if (requestsBody) requestsBody.innerHTML = ''; // 清空 (Clear)
        if (tokensBody) tokensBody.innerHTML = ''; // 清空 (Clear)

        const timeRanges = ['today', 'week', 'month'];
        const timeRangeLabels = {'today': '今日', 'week': '本周', 'month': '本月'};
        let requestsFound = false;
        let tokensFound = false;

        timeRanges.forEach(range => {
            // 请求次数 (Request Counts)
            if (requestsBody && topIps.requests && topIps.requests[range] && topIps.requests[range].length > 0) {
                requestsFound = true;
                topIps.requests[range].forEach(item => {
                    const row = requestsBody.insertRow();
                    row.insertCell().textContent = timeRangeLabels[range];
                    row.insertCell().textContent = item.ip;
                    row.insertCell().textContent = formatNumber(item.count);
                });
            }

            // 输入 Token (Input Tokens)
            if (tokensBody && topIps.tokens && topIps.tokens[range] && topIps.tokens[range].length > 0) {
                tokensFound = true;
                topIps.tokens[range].forEach(item => {
                    const row = tokensBody.insertRow();
                    row.insertCell().textContent = timeRangeLabels[range];
                    row.insertCell().textContent = item.ip;
                    row.insertCell().textContent = formatNumber(item.tokens);
                });
            }
        });

        // 如果某个表格完全没有数据，显示提示行
        // If a table has no data at all, show a message row
        if (requestsBody && !requestsFound) {
            const row = requestsBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 3;
            cell.textContent = '暂无请求记录'; // No request records
            cell.className = 'text-center text-muted';
        }
        if (tokensBody && !tokensFound) {
            const row = tokensBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 3;
            cell.textContent = '暂无 Token 记录'; // No token records
            cell.className = 'text-center text-muted';
        }
    }


    // 获取并渲染报告数据
    // Fetch and render report data
    async function fetchAndRenderReport() {
        // 显示加载中状态 (Show loading status)
        const lastUpdatedElemInit = document.getElementById('last-updated-time');
        if (lastUpdatedElemInit) lastUpdatedElemInit.textContent = '正在加载...';
        const keyStatusLoadingP = document.getElementById('key-status-loading');
        if (keyStatusLoadingP) keyStatusLoadingP.style.display = 'block'; // 检查元素是否存在
        const rpdStatsElemInit = document.getElementById('rpd-stats');
        if (rpdStatsElemInit) rpdStatsElemInit.textContent = '加载中...';
        const tpdInputStatsElemInit = document.getElementById('tpd-input-stats');
        if (tpdInputStatsElemInit) tpdInputStatsElemInit.textContent = '加载中...';
        const rpdPercentageElemInit = document.getElementById('rpd-percentage');
        if (rpdPercentageElemInit) rpdPercentageElemInit.textContent = '--%';
        const tpdInputPercentageElemInit = document.getElementById('tpd-input-percentage');
        if (tpdInputPercentageElemInit) tpdInputPercentageElemInit.textContent = '--%';
        const keySuggestionElemInit = document.getElementById('key-suggestion');
        if (keySuggestionElemInit) keySuggestionElemInit.textContent = '正在加载建议...';
        const topIpsRequestsElemInit = document.getElementById('top-ips-requests');
        if (topIpsRequestsElemInit) topIpsRequestsElemInit.innerHTML = '<tr><td colspan="3" class="text-center text-muted">正在加载...</td></tr>';
        const topIpsTokensElemInit = document.getElementById('top-ips-tokens');
        if (topIpsTokensElemInit) topIpsTokensElemInit.innerHTML = '<tr><td colspan="3" class="text-center text-muted">正在加载...</td></tr>';
        const activeKeysCountElemInit = document.getElementById('active-keys-count');
        if (activeKeysCountElemInit) activeKeysCountElemInit.textContent = '...';
        const invalidKeysStartupElemInit = document.getElementById('invalid-keys-startup');
        if (invalidKeysStartupElemInit) invalidKeysStartupElemInit.textContent = '...';
        const avgDailyRpdElemInit = document.getElementById('avg-daily-rpd');
        if (avgDailyRpdElemInit) avgDailyRpdElemInit.textContent = '...';
        const rpdCapacityTargetElemInit = document.getElementById('rpd-capacity-target');
        if (rpdCapacityTargetElemInit) rpdCapacityTargetElemInit.textContent = '...';
        const rpdCapacityOthersElemInit = document.getElementById('rpd-capacity-others');
        if (rpdCapacityOthersElemInit) rpdCapacityOthersElemInit.textContent = '';
        const tpdInputCapacityTargetElemInit = document.getElementById('tpd-input-capacity-target');
        if (tpdInputCapacityTargetElemInit) tpdInputCapacityTargetElemInit.textContent = '...';


        try {
            const accessToken = localStorage.getItem('access_token'); // 再次获取 token，确保是最新的
            if (!accessToken) {
                console.error('Report Page: fetchAndRenderReport called without token, redirecting.'); // Log error
                localStorage.removeItem('access_token'); // Clear any invalid state
                window.location.href = '/'; // Redirect to login page
                return; // Stop further processing
            }

            console.log(`Report Page: Fetching report data with token (first 10 chars): ${accessToken.substring(0, 10)}...`); // 调试日志：记录正在发送 token

            // Fetch report data from the backend API
            const response = await fetch('/api/report/data', {
                method: 'GET', // 明确指定方法
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${accessToken}` // 添加 Authorization 头部
                }
            });

            // --- 调试日志：打印响应状态码和响应体 ---
            console.log('Report Page: Received response status:', response.status);
            // 注意：如果响应体很大，读取 text() 可能会消耗大量内存。
            // 对于调试，可以先读取 text()，生产环境可能需要更谨慎处理。
            const responseBody = await response.text(); // 先读取文本，以便后续处理
            console.log('Report Page: Received response body (first 200 chars):', responseBody.substring(0, 200) + (responseBody.length > 200 ? '...' : '')); // 打印部分响应体
            // --- 调试日志结束 ---


            if (!response.ok) {
                // 处理非 200 状态码
                console.error(`Error fetching report data: ${response.status} - ${responseBody}`);
                // 显示错误信息给用户
                const lastUpdatedElemError = document.getElementById('last-updated-time');
                if (lastUpdatedElemError) lastUpdatedElemError.textContent = '加载失败';
                const rpdStatsElemError = document.getElementById('rpd-stats');
                if (rpdStatsElemError) rpdStatsElemError.textContent = `加载失败: ${response.status}`;
                const tpdInputStatsElemError = document.getElementById('tpd-input-stats');
                if (tpdInputStatsElemError) tpdInputStatsElemError.textContent = `加载失败: ${response.status}`;
                const keyStatusLoadingPError = document.getElementById('key-status-loading');
                if (keyStatusLoadingPError) keyStatusLoadingPError.textContent = `加载 Key 状态失败: ${response.status}`;
                const keySuggestionElemError = document.getElementById('key-suggestion');
                if (keySuggestionElemError) keySuggestionElemError.textContent = `加载建议失败: ${response.status}`;
                const topIpsRequestsElemError = document.getElementById('top-ips-requests');
                if (topIpsRequestsElemError) topIpsRequestsElemError.innerHTML = `<tr><td colspan="3" class="text-center text-danger">加载失败: ${response.status}</td></tr>`;
                const topIpsTokensElemError = document.getElementById('top-ips-tokens');
                if (topIpsTokensElemError) topIpsTokensElemError.innerHTML = `<tr><td colspan="3" class="text-center text-danger">加载失败: ${response.status}</td></tr>`;


                // 如果是认证失败，重定向到登录页
                if (response.status === 401 || response.status === 403) {
                     console.error('认证失败或无权限，请重新登录。'); // Authentication failed or no permission
                     localStorage.removeItem('access_token'); // 清除无效 Token
                     window.location.href = '/'; // 重定向到登录页
                }

                return; // 停止执行
            }

            // const data = await response.json(); // 需要重新解析 JSON，因为 text() 已经消费了 body
            let data;
            try {
                data = JSON.parse(responseBody);
            } catch (jsonError) {
                console.error('Report Page: Failed to parse response body as JSON:', jsonError);
                const lastUpdatedElemJsonError = document.getElementById('last-updated-time');
                if (lastUpdatedElemJsonError) lastUpdatedElemJsonError.textContent = '加载失败';
                const rpdStatsElemJsonError = document.getElementById('rpd-stats');
                if (rpdStatsElemJsonError) rpdStatsElemJsonError.textContent = `加载失败: JSON 解析错误`;
                const tpdInputStatsElemJsonError = document.getElementById('tpd-input-stats');
                if (tpdInputStatsElemJsonError) tpdInputStatsElemJsonError.textContent = `加载失败: JSON 解析错误`;
                const keyStatusLoadingPJsonError = document.getElementById('key-status-loading');
                if (keyStatusLoadingPJsonError) keyStatusLoadingPJsonError.textContent = `加载 Key 状态失败: JSON 解析错误`;
                const keySuggestionElemJsonError = document.getElementById('key-suggestion');
                if (keySuggestionElemJsonError) keySuggestionElemJsonError.textContent = `加载建议失败: JSON 解析错误`;
                const topIpsRequestsElemJsonError = document.getElementById('top-ips-requests');
                if (topIpsRequestsElemJsonError) topIpsRequestsElemJsonError.innerHTML = `<tr><td colspan="3" class="text-center text-danger">加载失败: JSON 解析错误</td></tr>`;
                const topIpsTokensElemJsonError = document.getElementById('top-ips-tokens');
                if (topIpsTokensElemJsonError) topIpsTokensElemJsonError.innerHTML = `<tr><td colspan="3" class="text-center text-danger">加载失败: JSON 解析错误</td></tr>`;
// 更新 RPD 容量估算 (多模型)
         // Update RPD Capacity Estimation (Multi-model)
         const rpdCapacityContainer = document.getElementById('rpd-capacity-list-container');
         const rpdCapacityPerModel = data.overall_stats?.rpd?.capacity_per_model;
         if (rpdCapacityContainer && rpdCapacityPerModel && Object.keys(rpdCapacityPerModel).length > 0) {
             rpdCapacityContainer.innerHTML = 'RPD 容量估算:'; // 重置标题
             const listDiv = document.createElement('div');
             listDiv.className = 'small mt-1'; // 使用 div 替代 ul/li，更简洁
             Object.entries(rpdCapacityPerModel).forEach(([model, capacityInfo]) => {
                 const itemDiv = document.createElement('div');
                 if (capacityInfo) {
                     itemDiv.innerHTML = `&nbsp;&nbsp;- <strong>${model}:</strong> ${formatNumber(capacityInfo.capacity)}/天 (基于 ${formatNumber(capacityInfo.limit)} RPD)`;
                 } else {
                     itemDiv.innerHTML = `&nbsp;&nbsp;- <strong>${model}:</strong> <span class="text-danger">限制未定义</span>`;
                 }
                 listDiv.appendChild(itemDiv);
             });
             rpdCapacityContainer.appendChild(listDiv);
         } else if (rpdCapacityContainer) {
             rpdCapacityContainer.innerHTML = 'RPD 容量估算: <div class="small text-muted mt-1">N/A</div>';
         }

         // 更新 TPD 输入容量估算 (多模型)
         // Update TPD Input Capacity Estimation (Multi-model)
         const tpdInputCapacityContainer = document.getElementById('tpd-input-capacity-list-container');
         const tpdInputCapacityPerModel = data.overall_stats?.tpd_input?.capacity_per_model;
         if (tpdInputCapacityContainer && tpdInputCapacityPerModel && Object.keys(tpdInputCapacityPerModel).length > 0) {
             tpdInputCapacityContainer.innerHTML = 'TPD 输入容量估算:'; // 重置标题
             const listDiv = document.createElement('div');
             listDiv.className = 'small mt-1';
             Object.entries(tpdInputCapacityPerModel).forEach(([model, capacityInfo]) => {
                 const itemDiv = document.createElement('div');
                 if (capacityInfo) {
                     itemDiv.innerHTML = `&nbsp;&nbsp;- <strong>${model}:</strong> ${formatNumber(capacityInfo.capacity)}/天 (基于 ${formatNumber(capacityInfo.limit)} TPD_In)`;
                 } else {
                     itemDiv.innerHTML = `&nbsp;&nbsp;- <strong>${model}:</strong> <span class="text-danger">限制未定义</span>`;
                 }
                 listDiv.appendChild(itemDiv);
             });
             tpdInputCapacityContainer.appendChild(listDiv);
         } else if (tpdInputCapacityContainer) {
             tpdInputCapacityContainer.innerHTML = 'TPD 输入容量估算: <div class="small text-muted mt-1">N/A</div>';
         }
                return;
            }


            // 更新最后更新时间
            const now = new Date();
            const lastUpdatedElem = document.getElementById('last-updated-time');
            if (lastUpdatedElem) {
                lastUpdatedElem.textContent = now.toLocaleString();
            }

            // 渲染容量图表和统计数据
            renderCapacityCharts(data.rpd_data, data.tpd_input_data);

            // 更新关键统计数据
            const activeKeysCountElem = document.getElementById('active-keys-count');
            if (activeKeysCountElem) {
                activeKeysCountElem.textContent = formatNumber(data.active_keys_count);
            }
            // 修正元素 ID 并添加空值检查
            const invalidKeysStartupElem = document.getElementById('invalid-keys-startup');
            if (invalidKeysStartupElem) {
                invalidKeysStartupElem.textContent = formatNumber(data.invalid_keys_startup);
            }
            // 修正元素 ID 并添加空值检查
            const avgDailyRpdElem = document.getElementById('avg-daily-rpd');
            if (avgDailyRpdElem) {
                avgDailyRpdElem.textContent = formatNumber(data.avg_daily_rpd);
            }
            const rpdCapacityTargetElem = document.getElementById('rpd-capacity-target');
            if (rpdCapacityTargetElem) {
                rpdCapacityTargetElem.textContent = formatNumber(data.rpd_capacity_target);
            }
            // 渲染其他模型的 RPD 容量估算
            const rpdCapacityOthers = data.rpd_capacity_others;
            const rpdCapacityOthersElem = document.getElementById('rpd-capacity-others');
            if (rpdCapacityOthersElem && rpdCapacityOthers) {
                let otherHtml = '';
                for (const [model, capacity] of Object.entries(rpdCapacityOthers)) {
                    otherHtml += `<div>${model}: ${formatNumber(capacity)}</div>`;
                }
                rpdCapacityOthersElem.innerHTML = otherHtml;
            }

            const tpdInputCapacityTargetElem = document.getElementById('tpd-input-capacity-target');
            if (tpdInputCapacityTargetElem) {
                tpdInputCapacityTargetElem.textContent = formatNumber(data.tpd_input_capacity_target);
            }

            // 渲染 Key 状态图表
            renderKeyStatusCharts(data.key_status_by_model);

            // 更新 Key 数量建议
            const keySuggestionElem = document.getElementById('key-suggestion');
            if (keySuggestionElem) {
                keySuggestionElem.textContent = data.key_suggestion || '暂无建议。';
            }

            // 填充 Top IP 表格
            populateTopIpTables(data.top_ips);

        } catch (error) {
            // --- 调试日志：打印捕获到的错误 ---
            console.error('Report Page: Error fetching and rendering report:', error);
            // --- 调试日志结束 ---
            // 显示错误信息给用户
            const lastUpdatedElemCatch = document.getElementById('last-updated-time');
            if (lastUpdatedElemCatch) lastUpdatedElemCatch.textContent = '加载失败';
            const rpdStatsElemCatch = document.getElementById('rpd-stats');
            if (rpdStatsElemCatch) rpdStatsElemCatch.textContent = `加载失败: ${error.message}`;
            const tpdInputStatsElemCatch = document.getElementById('tpd-input-stats');
            if (tpdInputStatsElemCatch) tpdInputStatsElemCatch.textContent = `加载失败: ${error.message}`;
            const keyStatusLoadingPCatch = document.getElementById('key-status-loading');
            if (keyStatusLoadingPCatch) keyStatusLoadingPCatch.textContent = `加载 Key 状态失败: ${error.message}`;
            const keySuggestionElemCatch = document.getElementById('key-suggestion');
            if (keySuggestionElemCatch) keySuggestionElemCatch.textContent = `加载建议失败: ${error.message}`;
            const topIpsRequestsElemCatch = document.getElementById('top-ips-requests');
            if (topIpsRequestsElemCatch) topIpsRequestsElemCatch.innerHTML = `<tr><td colspan="3" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
            const topIpsTokensElemCatch = document.getElementById('top-ips-tokens');
            if (topIpsTokensElemCatch) topIpsTokensElemCatch.innerHTML = `<tr><td colspan="3" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
        }
    }

    // 在 DOM 完全加载后再获取并渲染报告数据，确保元素存在
    // Fetch and render report data after the DOM is fully loaded to ensure elements exist
    document.addEventListener('DOMContentLoaded', fetchAndRenderReport);

    // 可选：设置定时刷新 (Optional: Set interval refresh)
    // setInterval(fetchAndRenderReport, 60000); // 每分钟刷新一次 (Refresh every minute)

</script>
{% endblock %}
